<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shared Spotify Radio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b0c10;
      color: #f2f2f2;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .card {
      background: #15171f;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      max-width: 480px;
      width: 100%;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #a0a4b8;
      margin-bottom: 16px;
    }
    label {
      font-size: 0.9rem;
      display: block;
      margin: 8px 0 4px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2a2d3a;
      background: #10121a;
      color: #f2f2f2;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      transform: scale(1.1);
      margin-right: 6px;
    }
    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      margin-right: 8px;
      margin-top: 12px;
      background: #1db954;
      color: #0b0c10;
    }
    button.secondary {
      background: #262a38;
      color: #f2f2f2;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .row {
      display: flex;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .status {
      margin-top: 14px;
      font-size: 0.85rem;
      color: #a0a4b8;
      min-height: 1.4em;
    }
    .small {
      font-size: 0.8rem;
      color: #7b7f95;
      margin-top: 10px;
      line-height: 1.4;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #262a38;
      color: #c4c7dd;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Shared Spotify Radio</h1>
    <div class="subtitle">
      One playlist, synced for everyone listening right now.
    </div>

    <label for="playlist">Spotify playlist URI</label>
    <input
      id="playlist"
      type="text"
      placeholder="Example: spotify:playlist:YOUR_PLAYLIST_ID"
    />

    <div class="row" style="margin-top: 10px;">
      <label style="margin: 0; display: flex; align-items: center;">
        <input type="checkbox" id="djToggle" />
        I am the DJ on this device
      </label>
      <span class="badge" id="roomLabel">Room: default</span>
    </div>

    <div class="row">
      <button id="loginBtn">Login to Spotify</button>
      <button id="playBtn" disabled>Play or resume</button>
      <button id="pauseBtn" class="secondary" disabled>Pause</button>
      <button id="syncBtn" class="secondary" disabled>Sync now</button>
    </div>

    <div class="status" id="status">Waiting for Spotify SDK...</div>

    <div class="small">
      To test: paste a playlist URI, mark yourself as DJ, login, hit play, then open the page on another device with the same room id.
    </div>
  </div>

  <!-- Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <!-- Your app logic with Firebase and Spotify -->
  <script type="module">
    // 1. Firebase setup
    // Replace with your config from the Firebase console
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 2. Simple room support from URL hash, default "main"
    const roomId = window.location.hash.replace("#", "") || "main";
    document.getElementById("roomLabel").textContent = "Room: " + roomId;

    const statusEl = document.getElementById("status");
    const playlistInput = document.getElementById("playlist");
    const loginBtn = document.getElementById("loginBtn");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const syncBtn = document.getElementById("syncBtn");
    const djToggle = document.getElementById("djToggle");

    let isDj = false;
    let player;
    let deviceId = null;
    let accessToken = null;
    let currentStateFromCloud = null;

    djToggle.addEventListener("change", () => {
      isDj = djToggle.checked;
      updateStatus();
    });

    function updateStatus(extra = "") {
      let base = "Room " + roomId + " · ";
      base += isDj ? "You are DJ" : "Listener only";
      if (deviceId) base += " · Device ready";
      if (extra) base += " · " + extra;
      statusEl.textContent = base;
    }

    // 3. Spotify auth placeholder
    // For quick testing you can paste a short lived access token here
    // In real use, implement the Authorization Code with PKCE flow
    // and return a valid token from this function.
    function getSpotifyAccessToken() {
      // Example for testing only:
      // return "BQD....YOUR_TEMP_TOKEN";
      return window.localStorage.getItem("spotify_access_token") || null;
    }

    loginBtn.addEventListener("click", () => {
      const token = getSpotifyAccessToken();
      if (!token) {
        alert(
          "You need to plug your own Spotify login flow.\nStore the access token in localStorage under spotify_access_token or edit getSpotifyAccessToken() to return it."
        );
        return;
      }
      accessToken = token;
      startSpotifyPlayer();
    });

    // 4. Start the Spotify Web Playback SDK player
    window.onSpotifyWebPlaybackSDKReady = () => {
      statusEl.textContent = "Spotify SDK ready. Press Login to connect.";
    };

    function startSpotifyPlayer() {
      if (!accessToken) {
        statusEl.textContent = "No Spotify access token.";
        return;
      }

      if (player) {
        statusEl.textContent = "Player already started.";
        return;
      }

      player = new Spotify.Player({
        name: "GitHub Radio " + roomId,
        getOAuthToken: cb => {
          cb(accessToken);
        },
        volume: 0.8
      });

      player.addListener("ready", ({ device_id }) => {
        deviceId = device_id;
        playBtn.disabled = false;
        pauseBtn.disabled = false;
        syncBtn.disabled = false;
        updateStatus("Spotify device " + device_id.slice(0, 6));
        attachCloudListener();
      });

      player.addListener("not_ready", ({ device_id }) => {
        updateStatus("Device offline " + device_id);
      });

      player.addListener("initialization_error", ({ message }) => {
        console.error(message);
        statusEl.textContent = "Initialization error: " + message;
      });

      player.addListener("authentication_error", ({ message }) => {
        console.error(message);
        statusEl.textContent = "Authentication error: " + message;
      });

      player.addListener("account_error", ({ message }) => {
        console.error(message);
        statusEl.textContent = "Account error: " + message;
      });

      player.connect();
    }

    // 5. Firebase sync logic
    const stateRef = ref(db, "radioRooms/" + roomId + "/state");

    function writeStateToCloud(localState) {
      if (!isDj) return;
      const body = {
        playlistUri: localState.playlistUri || null,
        isPlaying: !!localState.isPlaying,
        positionMs: localState.positionMs || 0,
        updatedAt: Date.now()
      };
      set(stateRef, body).catch(err => {
        console.error(err);
        statusEl.textContent = "Error writing to Firebase.";
      });
    }

    function attachCloudListener() {
      onValue(stateRef, snapshot => {
        const val = snapshot.val();
        if (!val) return;
        currentStateFromCloud = val;
        updateStatus(val.isPlaying ? "Playing" : "Paused");
        handleIncomingState(val);
      });
    }

    async function handleIncomingState(state) {
      if (!player || !deviceId || !accessToken) return;
      if (!state.playlistUri) return;

      // Use Spotify Web API to start or pause playback for this browser device
      if (state.isPlaying) {
        await playPlaylistAtPosition(state.playlistUri, state.positionMs || 0);
      } else {
        await pausePlayback();
      }
    }

    async function playPlaylistAtPosition(playlistUri, positionMs) {
      if (!accessToken || !deviceId) return;

      try {
        const body = {
          context_uri: playlistUri,
          position_ms: positionMs
        };
        await fetch(
          "https://api.spotify.com/v1/me/player/play?device_id=" + encodeURIComponent(deviceId),
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + accessToken
            },
            body: JSON.stringify(body)
          }
        );
        updateStatus("Play command sent");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error sending play command.";
      }
    }

    async function pausePlayback() {
      if (!accessToken || !deviceId) return;
      try {
        await fetch(
          "https://api.spotify.com/v1/me/player/pause?device_id=" + encodeURIComponent(deviceId),
          {
            method: "PUT",
            headers: {
              Authorization: "Bearer " + accessToken
            }
          }
        );
        updateStatus("Pause command sent");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error sending pause command.";
      }
    }

    // 6. Button handlers for the DJ
    playBtn.addEventListener("click", async () => {
      if (!isDj) {
        alert("Only the DJ can send play commands to the room.");
        return;
      }
      const uri = playlistInput.value.trim();
      if (!uri) {
        alert("Enter a Spotify playlist URI first.");
        return;
      }
      // Start from zero for now
      await playPlaylistAtPosition(uri, 0);
      writeStateToCloud({
        playlistUri: uri,
        isPlaying: true,
        positionMs: 0
      });
    });

    pauseBtn.addEventListener("click", async () => {
      if (!isDj) {
        alert("Only the DJ can send pause commands.");
        return;
      }
      await pausePlayback();
      writeStateToCloud({
        playlistUri: playlistInput.value.trim(),
        isPlaying: false,
        positionMs: 0
      });
    });

    syncBtn.addEventListener("click", async () => {
      if (!isDj) {
        alert("Only the DJ can sync the room state.");
        return;
      }
      if (!player) return;

      const state = await player.getCurrentState();
      if (!state) {
        alert("No current state from Spotify player.");
        return;
      }
      const positionMs = state.position || 0;
      const uri = playlistInput.value.trim() || (currentStateFromCloud && currentStateFromCloud.playlistUri);

      writeStateToCloud({
        playlistUri: uri,
        isPlaying: !state.paused,
        positionMs
      });

      updateStatus("Synced at " + Math.round(positionMs / 1000) + " seconds");
    });

    // Initial status
    updateStatus("Idle");
  </script>
</body>
</html>
